{
  "kind": "build_request",
  "title": "Fix production APK download serving HTML instead of a valid APK",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-57",
      "text": "Ensure the public URL path `/assets/primepost.apk` in production serves the real Android APK binary (a valid ZIP/APK starting with the `PK` header), not an HTML/text response, and that the downloaded file installs on Android without the error message “There was a problem parsing the package.”",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "The apk is not working. It's showing the same error. Please send it as APK not HTML"
        ]
      },
      "acceptanceCriteria": [
        "From a deployed environment, downloading `GET /assets/primepost.apk` returns a binary file whose first 2 bytes are `PK` (0x50 0x4B).",
        "`GET /assets/primepost.apk` returns a multi-megabyte file (>= 1 MB) and is not an HTML page or error document.",
        "Installing the downloaded APK on an Android device completes successfully and the app launches.",
        "The response headers for `/assets/primepost.apk` use a binary content type (acceptable: `application/vnd.android.package-archive` or `application/octet-stream`) and do not indicate HTML (`text/html`)."
      ]
    },
    {
      "id": "REQ-58",
      "text": "Update the production build/deploy workflow so that every deployment explicitly stages and includes `frontend/public/assets/primepost.apk` and `frontend/public/assets/primepost.apk.meta.json` generated from the latest Android build output, preventing missing/stale assets that cause `/assets/primepost.apk` to fall back to an HTML response.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Please send it as APK not HTML"
        ]
      },
      "acceptanceCriteria": [
        "A clean production build (no prior artifacts) produces `frontend/public/assets/primepost.apk` and `frontend/public/assets/primepost.apk.meta.json` before the frontend is built/deployed.",
        "The deployed `/assets/primepost.apk.meta.json` reports a `size` that matches the deployed `/assets/primepost.apk` file size and a non-empty `sha256`.",
        "If staging detects a missing/too-small/invalid APK, the build fails fast (no deployment is produced)."
      ]
    },
    {
      "id": "REQ-59",
      "text": "Add an automated post-deploy verification step (using the existing optional `DEPLOY_URL` remote verification behavior in the APK build scripts) that checks the deployed `/assets/primepost.apk` and `/assets/primepost.apk.meta.json` for size/SHA-256 match and validates the deployed APK header is `PK`; fail the pipeline if the deployed asset is HTML, truncated, or mismatched.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "It's showing the same error. Please send it as APK not HTML"
        ]
      },
      "acceptanceCriteria": [
        "When `DEPLOY_URL` is provided, the build/publish process verifies remote `/assets/primepost.apk` size and SHA-256 match the locally built artifact.",
        "When `DEPLOY_URL` is provided, the build/publish process verifies the remote `/assets/primepost.apk` begins with the `PK` header and fails if it does not.",
        "The pipeline reports clear English error output indicating whether the deployed file is missing, too small, mismatched, or not a valid APK binary."
      ]
    }
  ],
  "constraints": [
    "Frontend immutablePaths must not be edited (including `frontend/src/hooks/useInternetIdentity.ts(x)`, `frontend/src/hooks/useActor.ts`, and `frontend/src/main.tsx`).",
    "Backend must remain a single Motoko actor (`backend/main.mo`); add `backend/migration.mo` only if an actual state upgrade is required."
  ],
  "nonGoals": [
    "Creating a release-signed (non-debug) APK or changing Android signing/keystore strategy.",
    "Adding new app features unrelated to APK artifact correctness and delivery.",
    "Replacing the existing APK download page UX (only correctness and verification of the served APK are in scope)."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}