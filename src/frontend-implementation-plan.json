{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Ensure production APK asset is correctly staged, served as binary, and verified post-deploy",
  "requirements": [
    {
      "id": "REQ-57",
      "summary": "Prevent `/assets/primepost.apk` from being served as HTML by validating and surfacing deployed APK binary/header/content-type correctness on the download UI.",
      "acceptanceCriteria": [
        "From a deployed environment, downloading `GET /assets/primepost.apk` returns a binary file whose first 2 bytes are `PK` (0x50 0x4B).",
        "`GET /assets/primepost.apk` returns a multi-megabyte file (>= 1 MB) and is not an HTML page or error document.",
        "Installing the downloaded APK on an Android device completes successfully and the app launches.",
        "The response headers for `/assets/primepost.apk` use a binary content type (acceptable: `application/vnd.android.package-archive` or `application/octet-stream`) and do not indicate HTML (`text/html`)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/utils/apkIntegrity.ts",
          "operation": "modify",
          "description": "Extend APK integrity utilities to (a) fetch and validate `/assets/primepost.apk` using a byte-range request to confirm the `PK` header, (b) read response headers to detect HTML/text content types, and (c) optionally cross-check the downloaded size/SHA-256 against `/assets/primepost.apk.meta.json`, returning structured status/error details for the UI."
        },
        {
          "path": "frontend/src/pages/public/ApkDownloadPage.tsx",
          "operation": "modify",
          "description": "Update the APK download page to call the enhanced integrity checks (PK header + content-type + size/SHA match) and clearly warn/block download when the deployed asset appears to be HTML, too small, or otherwise invalid, without changing the overall page UX beyond correctness messaging."
        }
      ]
    },
    {
      "id": "REQ-58",
      "summary": "Fail-fast staging that always generates and includes `public/assets/primepost.apk` and `public/assets/primepost.apk.meta.json` from the latest Android build output before deployment.",
      "acceptanceCriteria": [
        "A clean production build (no prior artifacts) produces `frontend/public/assets/primepost.apk` and `frontend/public/assets/primepost.apk.meta.json` before the frontend is built/deployed.",
        "The deployed `/assets/primepost.apk.meta.json` reports a `size` that matches the deployed `/assets/primepost.apk` file size and a non-empty `sha256`.",
        "If staging detects a missing/too-small/invalid APK, the build fails fast (no deployment is produced)."
      ],
      "file_operations": [
        {
          "path": "frontend/scripts/stage-android-apk-assets.sh",
          "operation": "modify",
          "description": "Tighten staging validation to always ensure both `public/assets/primepost.apk` and `public/assets/primepost.apk.meta.json` exist, enforce >=1MB size, verify `PK` header, and require metadata `size` to match the APK size with a non-empty `sha256`; ensure any invalid/missing/stale condition exits non-zero with clear English error output."
        },
        {
          "path": "frontend/scripts/stage-android-apk-assets.ps1",
          "operation": "modify",
          "description": "Align Windows staging behavior with the shell version: enforce >=1MB, verify `PK` header, require metadata `size` match and non-empty `sha256`, and fail fast with clear English errors if assets are missing/invalid/stale."
        },
        {
          "path": "frontend/scripts/build-android-apk-debug.sh",
          "operation": "modify",
          "description": "Harden the publish step that copies the built APK into `public/assets/primepost.apk` and generates `public/assets/primepost.apk.meta.json` by ensuring the metadata is always written with a real SHA-256 (fail if hash tooling is unavailable) and by keeping size/header/byte-identical checks as deployment blockers (non-zero exit on any mismatch)."
        },
        {
          "path": "frontend/scripts/build-android-apk-debug.ps1",
          "operation": "modify",
          "description": "Harden the Windows publish step to ensure metadata is always written with a non-empty SHA-256 and that size/header/integrity checks block deployment (non-zero exit on any mismatch)."
        },
        {
          "path": "frontend/docs/android-apk-build.md",
          "operation": "modify",
          "description": "Update documentation to instruct production build/deploy workflows to run the staging script before building/deploying the frontend, explicitly calling out that missing/too-small/invalid APK assets must fail the build to avoid `/assets/primepost.apk` falling back to an HTML response."
        }
      ]
    },
    {
      "id": "REQ-59",
      "summary": "Add strict post-deploy remote verification (gated by `DEPLOY_URL`) to validate deployed APK header and metadata size/SHA match, failing the pipeline on mismatch/HTML/truncation.",
      "acceptanceCriteria": [
        "When `DEPLOY_URL` is provided, the build/publish process verifies remote `/assets/primepost.apk` size and SHA-256 match the locally built artifact.",
        "When `DEPLOY_URL` is provided, the build/publish process verifies the remote `/assets/primepost.apk` begins with the `PK` header and fails if it does not.",
        "The pipeline reports clear English error output indicating whether the deployed file is missing, too small, mismatched, or not a valid APK binary."
      ],
      "file_operations": [
        {
          "path": "frontend/scripts/build-android-apk-debug.sh",
          "operation": "modify",
          "description": "Make remote verification strict when `DEPLOY_URL` is set: require needed tools (curl + jq), require remote metadata fetch to succeed, validate remote `Content-Type` is not HTML, validate remote meta `size`/`sha256` match local, and validate remote first 2 bytes are `PK`; on any failure, exit non-zero with clear English errors (missing/too small/mismatched/not PK/HTML)."
        },
        {
          "path": "frontend/scripts/build-android-apk-debug.ps1",
          "operation": "modify",
          "description": "Make remote verification strict when `DEPLOY_URL` is set: require successful remote metadata fetch, validate remote headers indicate binary (not HTML), validate remote size/SHA match local, and validate remote first 2 bytes are `PK`; on any failure, exit non-zero with clear English errors (missing/too small/mismatched/not PK/HTML)."
        },
        {
          "path": "frontend/scripts/stage-android-apk-assets.sh",
          "operation": "modify",
          "description": "When `DEPLOY_URL` is provided, invoke or replicate the strict remote verification behavior after staging so that CI/CD can run a single staging step and still fail the pipeline if the deployed `/assets/primepost.apk` is HTML/truncated/mismatched."
        },
        {
          "path": "frontend/scripts/stage-android-apk-assets.ps1",
          "operation": "modify",
          "description": "When `DEPLOY_URL` is provided, invoke or replicate the strict remote verification behavior after staging so that CI/CD can run a single staging step and still fail the pipeline if the deployed `/assets/primepost.apk` is HTML/truncated/mismatched."
        }
      ]
    }
  ]
}